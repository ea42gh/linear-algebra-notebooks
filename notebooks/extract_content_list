#!/bin/bash

INDEX_FILE="Index.ipynb"
OUTPUT_FILE="List_of_Contents.md"
TEMP_CHAPTERS="temp_chapters.txt"

# Pass 1: Extract chapters and notebooks
> "$OUTPUT_FILE"
> "$TEMP_CHAPTERS"

cat "$INDEX_FILE" | \
awk '
/"source": \[\s*"#[ 0-9][^"]*"/ { 
  if (match($0, /"# ([^"]*)"/, arr)) {
    print "# " arr[1] >> "'$OUTPUT_FILE'"
    print "" >> "'$OUTPUT_FILE'"
    chapter = arr[1]
    in_table = 0
    delete notebooks
    next
  }
}
/"cell_type": "markdown"/ { in_table = 1 }
/\|\s*\[[^]]*\.ipynb\]/ && in_table {
  if (match($0, /\[([^\]]*\.ipynb)\]/, arr)) {
    print arr[1] >> "'$TEMP_CHAPTERS'"
  }
}
' "$INDEX_FILE"

# Pass 2: For each notebook in temp file, extract headings
while IFS= read -r notebook; do
  if [ -f "$notebook" ]; then
    echo "## $notebook" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    
    # Extract headings using your exact egrep/sed pattern
    egrep '"#+ [0-9]' "$notebook" | \
    sed 's/^[^"]*//;s/"//g;s/\\n//;s/,$//;s/\\\\/\\/g' | \
    sed 's/^### /##### /' | \
    sed 's/^## /#### /' | \
    sed 's/^# /### /' >> "$OUTPUT_FILE"
    
    echo "" >> "$OUTPUT_FILE"
  fi
done < "$TEMP_CHAPTERS"

rm -f "$TEMP_CHAPTERS"

echo "" >> "$OUTPUT_FILE"
echo "âœ… Generated $OUTPUT_FILE with full notebook headings"

